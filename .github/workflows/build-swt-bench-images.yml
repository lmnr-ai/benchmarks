name: Build SWT-Bench Images

on:
  pull_request_target:
    types: [labeled]
  workflow_dispatch:
    inputs:
      dataset:
        description: 'Dataset name (e.g., princeton-nlp/SWE-bench_Verified)'
        required: true
        default: 'princeton-nlp/SWE-bench_Verified'
        type: string
      split:
        description: 'Dataset split'
        required: true
        default: 'test'
        type: string
      max-workers:
        description: 'Maximum number of parallel workers'
        required: false
        default: '4'
        type: string
      n-limit:
        description: 'Limit number of images to build (0 for all)'
        required: false
        default: '0'
        type: string
      instance-ids:
        description: 'Comma-separated instance IDs to build (optional, overrides n-limit)'
        required: false
        default: ''
        type: string
      sdk-commit:
        description: 'Software Agent SDK commit/ref to use'
        required: true
        type: string

concurrency:
  group: build-swt-bench-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-push:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request_target' &&
       github.event.label.name == 'build-swt-bench')

    runs-on:
      labels: blacksmith-32vcpu-ubuntu-2204

    permissions:
      contents: read
      packages: write
      issues: write

    # Defaults for automatic runs; keep INSTANCE_IDS/SELECT_FILE initialized so set -euo pipefail won't fail on unset vars.
    env:
      DATASET: princeton-nlp/SWE-bench_Verified
      SPLIT: test
      MAX_WORKERS: '4'
      N_LIMIT: '0'
      INSTANCE_IDS: ''
      SELECT_FILE: ''

    steps:
      - name: Determine checkout ref
        id: checkout-ref
        run: |
          if [ -n "${{ github.event.pull_request.head.sha }}" ]; then
            echo "ref=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            echo "Using PR head SHA: ${{ github.event.pull_request.head.sha }}"
          else
            echo "ref=" >> "$GITHUB_OUTPUT"
            echo "Using default ref (the commit that triggered this workflow)"
          fi

      - uses: actions/checkout@v6
        with:
          ref: ${{ steps.checkout-ref.outputs.ref }}
          submodules: recursive

      - name: Update SDK submodule
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.sdk-commit != '' }}
        run: |
          cd vendor/software-agent-sdk
          git fetch origin ${{ inputs.sdk-commit }}
          git checkout FETCH_HEAD
          SDK_SHA=$(git rev-parse HEAD)
          cd ../..
          git add vendor/software-agent-sdk
          echo "Updated SDK submodule to $SDK_SHA (from ${{ inputs.sdk-commit }})"

      - name: Set up Docker Buildx with Blacksmith
        uses: useblacksmith/setup-docker-builder@v1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          make build

      - name: Build and push SWT-Bench images
        run: |
          set -euo pipefail

          # Get inputs with defaults
          DATASET="${{ inputs.dataset || 'princeton-nlp/SWE-bench_Verified' }}"
          SPLIT="${{ inputs.split || 'test' }}"
          MAX_WORKERS="${{ inputs.max-workers || '4' }}"
          N_LIMIT="${{ inputs.n-limit || '0' }}"
          INSTANCE_IDS="${{ inputs.instance-ids }}"

          # SWT-Bench uses source-minimal target (same as SWE-bench)
          TARGET="source-minimal"

          SELECT_FILE=""
          if [ -n "${INSTANCE_IDS}" ]; then
            SELECT_FILE="${RUNNER_TEMP}/selected-instances.txt"
            echo "Creating selected instances file at ${SELECT_FILE}"
            echo "${INSTANCE_IDS}" \
              | tr ',' '\n' \
              | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' \
              | sed '/^$/d' > "${SELECT_FILE}"
            # When explicit instances are provided, ignore n-limit to avoid double filtering
            N_LIMIT="0"
          fi

          CMD="uv run benchmarks/swtbench/build_images.py \
            --dataset ${DATASET} \
            --split ${SPLIT} \
            --image ghcr.io/openhands/eval-agent-server \
            --target ${TARGET} \
            --max-workers ${MAX_WORKERS} \
            --push"

          # Add n-limit if specified
          if [ "$N_LIMIT" != "0" ]; then
            CMD="$CMD --n-limit ${N_LIMIT}"
          fi
          if [ -n "${SELECT_FILE}" ]; then
            CMD="$CMD --select ${SELECT_FILE}"
          fi

          echo "Running: $CMD"
          eval "$CMD"
        env:
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain

      - name: Archive build logs
        if: always()
        run: |
          if [ -d builds ]; then
            tar -czf build-logs.tar.gz builds/
            echo "Build logs archived successfully"
          else
            echo "No builds directory found"
          fi

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: build-logs-${{ github.run_id }}
          path: build-logs.tar.gz
          retention-days: 7
          if-no-files-found: warn

      - name: Display build summary
        if: always()
        run: |
          MANIFEST_FILE=$(find builds -name "manifest.jsonl" -type f 2>/dev/null | head -1 || true)

          if [ -z "$MANIFEST_FILE" ]; then
            echo "## Build Summary" >> "$GITHUB_STEP_SUMMARY"
            echo "❌ Build failed - no manifest found" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          # Count total images built
          TOTAL_IMAGES=$(wc -l < "$MANIFEST_FILE")
          SUCCESS_COUNT=$(grep -c '"error":null' "$MANIFEST_FILE" || echo 0)
          FAIL_COUNT=$((TOTAL_IMAGES - SUCCESS_COUNT))

          echo "## SWT-Bench Image Build Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Total Images:** $TOTAL_IMAGES" >> "$GITHUB_STEP_SUMMARY"
          echo "**Successful:** $SUCCESS_COUNT ✅" >> "$GITHUB_STEP_SUMMARY"
          echo "**Failed:** $FAIL_COUNT ❌" >> "$GITHUB_STEP_SUMMARY"

      - name: Comment on tracker issue
        if: success()
        run: |
          # Get SDK version
          SDK_SHA=$(git submodule status vendor/software-agent-sdk | awk '{print $1}' | sed 's/^[+-]//')
          SDK_SHA_SHORT=${SDK_SHA:0:7}

          # Read build summary
          MANIFEST_FILE=$(find builds -name "manifest.jsonl" -type f 2>/dev/null | head -1 || true)

          if [ -z "$MANIFEST_FILE" ]; then
            echo "No manifest file found"
            exit 0
          fi

          TOTAL_IMAGES=$(wc -l < "$MANIFEST_FILE")
          SUCCESS_COUNT=$(grep -c '"error":null' "$MANIFEST_FILE" || echo 0)

          # Determine trigger source
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TRIGGER="Manual trigger (workflow_dispatch)"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            TRIGGER="Pull request [#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})"
          else
            TRIGGER="${{ github.event_name }}"
          fi

          # Post comment using jq to properly handle multi-line content
          jq -n \
            --arg sdk_short "${SDK_SHA_SHORT}" \
            --arg sdk_full "${SDK_SHA}" \
            --arg total "$TOTAL_IMAGES" \
            --arg success "$SUCCESS_COUNT" \
            --arg run_id "${{ github.run_id }}" \
            --arg server_url "${{ github.server_url }}" \
            --arg repo "${{ github.repository }}" \
            --arg trigger "${TRIGGER}" \
            '{body: "## SWT-Bench Image Build Complete ✅\n\n**SDK Version:** [`\($sdk_short)`](https://github.com/OpenHands/software-agent-sdk/commit/\($sdk_full))\n**Images Built:** \($success)/\($total)\n**Workflow Run:** [#\($run_id)](\($server_url)/\($repo)/actions/runs/\($run_id))\n**Triggered by:** \($trigger)\n\nSWT-Bench images have been built and pushed to ghcr.io/openhands/eval-agent-server."}' | \
          curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/81/comments" \
            -d @-
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
